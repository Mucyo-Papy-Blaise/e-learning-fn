import axiosInstance from "../axios";
import { API_URL } from "@/lib/axios"

export type InstructorProfile = {
  _id: string;
  user_id: {
    _id: string;
    name: string;
    email: string;
    phone?: string;
    isActive?: boolean;
    isVerified?: boolean;
  };
  profession_name?: string;
  bio?: string;
  expertise?: string[];
  social_links?: Record<string, string>;
  profile_image?: string;
};

export async function getMyInstructorProfile(): Promise<{ message: string; instructor: InstructorProfile }>{
  const res = await axiosInstance.get(`${API_URL}/api/instructor/profile`);
  return res.data;
}

export async function updateMyInstructorProfile(form: FormData): Promise<{ message: string; instructor: InstructorProfile }>{
  const res = await axiosInstance.put(`${API_URL}/api/instructor/profile`, form, {
    headers: { "Content-Type": "multipart/form-data" },
  });
  return res.data;
}

export async function updateInstructorAccount(payload: { name?: string; phone?: string }): Promise<{ message: string; user: any }>{
  const res = await axiosInstance.put(`${API_URL}/api/instructor/account`, payload);
  return res.data;
}


export type InstructorDashboard = any;

export async function fetchInstructorDashboard(): Promise<InstructorDashboard> {
  const response = await axiosInstance.get(`${API_URL}/api/instructor/dashboard`, {
    headers: {
      Authorization: `Bearer ${localStorage.getItem("token")}`,
    },
  });
  const raw = response.data?.data ?? response.data?.dashboard ?? response.data;

  const toCount = (val: any): number => {
    if (Array.isArray(val)) return val.length;
    if (val && typeof val === 'object') {
      if (typeof val.total === 'number') return val.total;
      if (typeof val.count === 'number') return val.count;
      if (typeof val.value === 'number') return val.value;
      // Fallback: number of keys for object shapes
      return Object.keys(val).length;
    }
    const n = Number(val);
    return Number.isFinite(n) ? n : 0;
  };

  return {
    courses: toCount(raw?.courses),
    students: toCount(raw?.students),
    hours: Number(raw?.hours ?? 0),
  };
}